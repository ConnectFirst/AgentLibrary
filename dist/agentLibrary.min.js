/*! cf-agent-library - v0.0.0 - 2016-08-15 - Connect First */
!function(a){function b(a){var b={auxData1:a["@aux_data1"],auxData2:a["@aux_data2"],auxData3:a["@aux_data3"],auxData4:a["@aux_data4"],auxData5:a["@aux_data5"],destination:a["@destination"],dialGroupId:a["@dial_group_id"],dialGroupName:a["@dial_group_name"],dialTime:a["@dial_time"],externId:a["@extern_id"],leadId:a["@lead_id"],firstName:A.getText(a,"first_name"),midName:A.getText(a,"mid_name"),lastName:A.getText(a,"last_name"),sufix:A.getText(a,"suffix"),title:A.getText(a,"title"),address1:A.getText(a,"address1"),address2:A.getText(a,"address2"),city:A.getText(a,"city"),state:A.getText(a,"state"),zip:A.getText(a,"zip"),gateKeeper:A.getText(a,"gate_keeper")};return b}function c(a){for(var b=z.getInstance(),c=b.outboundSettings.availableOutdialGroups,d=0;d<c.length;d++){var e=c[d];e.dialGroupId===a.ui_response.outdial_group_id["#text"]&&(b.agentPermissions.allowLeadSearch=e.allowLeadSearch,b.agentPermissions.allowPreviewLeadFilters=e.allowPreviewLeadFilters,b.outboundSettings.outdialGroup=JSON.parse(JSON.stringify(e)),b.agentPermissions.requireFetchedLeadsCalled=e.requireFetchedLeadsCalled)}}function d(){for(var a=z.getInstance(),b=a.inboundSettings.availableQueues,c=a.configRequest.queueIds,d=[],e=0;e<b.length;e++){var f=b[e];c.indexOf(f.gateId)>-1&&d.push(f)}a.inboundSettings.queues=JSON.parse(JSON.stringify(d))}function e(){for(var a=z.getInstance(),b=a.chatSettings.availableChatQueues,c=a.configRequest.chatIds,d=[],e=0;e<b.length;e++){var f=b[e];c.indexOf(f.chatQueueId)>-1&&d.push(f)}a.chatSettings.chatQueues=JSON.parse(JSON.stringify(d))}function f(){for(var a=z.getInstance(),b=a.inboundSettings.availableSkillProfiles,c=0;c<b.length;c++){var d=b[c];d.skillProfileId===a.configRequest.skillProfileId&&(a.inboundSettings.skillProfile=JSON.parse(JSON.stringify(d)))}}function g(a,b){var c=z.getInstance(),d={};if(h(b.queue)){var e=[];if(a.generic_key_value_pairs){var f=A.getText(a,"generic_key_value_pairs");f.length>0&&(e=util.parseKeyValuePairsFromString(f,"|","::"))}for(var g in e)d[g]=e[g]}d.ani=b.ani,d.dnis=b.dnis,d.uii=b.uii;try{b.queue.number?(d.source_id=b.number,d.source_name=b.name,d.source_desc=b.description,"0"===b.queue.isCampaign?d.source_type="INBOUND":d.source_type="OUTBOUND"):(d.source_id="0",d.source_type="MANUAL",d.source_name="",d.source_desc="")}catch(i){console.error("There was an error processing source tokenization",+i)}try{d.agent_first_name=c.agentSettings.firstName,d.agent_last_name=c.agentSettings.lastName,d.agent_external_id=c.agentSettings.externalAgentId,d.agent_extern_id=c.agentSettings.externalAgentId,d.agent_type=c.agentSettings.agentType}catch(i){console.error("There was an error parsing tokens for agent info. ",i)}if(a.baggage)try{d.lead_id=b.baggage.leadId,d.extern_id=b.baggage.externId,d.first_name=b.baggage.firstName,d.mid_name=b.baggage.midName,d.last_name=b.baggage.lastName,d.address1=b.baggage.address1,d.address2=b.baggage.address2,d.suffix=b.baggage.suffix,d.title=b.baggage.title,d.city=b.baggage.city,d.state=b.baggage.state,d.zip=b.baggage.zip,d.aux_data1=b.baggage.auxData1,d.aux_data2=b.baggage.auxData2,d.aux_data3=b.baggage.auxData3,d.aux_data4=b.baggage.auxData4,d.aux_data5=b.baggage.auxData5,d.aux_phone=b.baggage.auxPhone,d.email=b.baggage.email,d.gate_keeper=b.baggage.gateKeeper}catch(i){console.error("There was an error parsing baggage tokens. ",i)}else d.lead_id="",d.extern_id="",d.first_name="",d.mid_name="",d.last_name="",d.address1="",d.address2="",d.suffix="",d.title="",d.city="",d.state="",d.zip="",d.aux_data1="",d.aux_data2="",d.aux_data3="",d.aux_data4="",d.aux_data5="",d.aux_phone="",d.email="",d.gate_keeper="";return d}function h(a){return a&&a.isCampaign?"1"===a.isCampaign:!1}function i(a){"use strict";var b=a.AgentLibrary=function(a){return a=a||{},this.callbacks={},this._requests={},"undefined"!=typeof a.callbacks&&(this.callbacks=a.callbacks),"undefined"!=typeof a.socketDest&&(z.getInstance().applicationSettings.socketDest=a.socketDest,this.openSocket()),this};b.prototype.setCallbacks=function(a){for(var b in a)this.callbacks[b]=a[b]},b.prototype.setCallback=function(a,b){this.callbacks[a]=b},b.prototype.getCallbacks=function(){return this.callbacks},b.prototype.getCallback=function(a){return this.callbacks[a]},b.prototype.getLoginRequest=function(){return z.getInstance().loginRequest},b.prototype.getConfigRequest=function(){return z.getInstance().configRequest},b.prototype.getLogoutRequest=function(){return z.getInstance().logoutRequest},b.prototype.getAgentDailyStats=function(){return z.getInstance().agentDailyStats},b.prototype.getCallTokens=function(){return z.getInstance().callTokens},b.prototype.getAgentStateRequest=function(){return z.getInstance().agentStateRequest},b.prototype.getOffhookInitRequest=function(){return z.getInstance().offhookInitRequest},b.prototype.getOffhookTermRequest=function(){return z.getInstance().offhookTermRequest},b.prototype.getLoginPacket=function(){return z.getInstance().loginPacket},b.prototype.getConfigPacket=function(){return z.getInstance().configPacket},b.prototype.getAgentStatePacket=function(){return z.getInstance().agentStatePacket},b.prototype.getCurrentCallPacket=function(){return z.getInstance().currentCallPacket},b.prototype.getOffhookInitPacket=function(){return z.getInstance().offhookInitPacket},b.prototype.getOffhookTermPacket=function(){return z.getInstance().offhookTermPacket},b.prototype.getDialGroupChangeNotification=function(){return z.getInstance().dialGroupChangeNotification},b.prototype.getDialGroupChangePendingNotification=function(){return z.getInstance().dialGroupChangePendingNotification},b.prototype.getEndCallNotification=function(){return z.getInstance().endCallNotification},b.prototype.getGatesChangeNotification=function(){return z.getInstance().gatesChangeNotification},b.prototype.getGenericNotification=function(){return z.getInstance().genericNotification},b.prototype.getNewCallNotification=function(){return z.getInstance().newCallNotification},b.prototype.getCurrentCall=function(){return z.getInstance().currentCall},b.prototype.getApplicationSettings=function(){return z.getInstance().applicationSettings},b.prototype.getChatSettings=function(){return z.getInstance().chatSettings},b.prototype.getConnectionSettings=function(){return z.getInstance().connectionSettings},b.prototype.getInboundSettings=function(){return z.getInstance().inboundSettings},b.prototype.getOutboundSettings=function(){return z.getInstance().outboundSettings},b.prototype.getAgentSettings=function(){return z.getInstance().agentSettings},b.prototype.getAgentPermissions=function(){return z.getInstance().agentPermissions}}function j(a){"use strict";var b=a.AgentLibrary;b.prototype.openSocket=function(b){var c=this;A.setCallback(c,B.OPEN_SOCKET,b),"WebSocket"in a?(console.log("AgentLibrary: attempting to open socket connection..."),c.socket=new WebSocket(z.getInstance().applicationSettings.socketDest),c.socket.onopen=function(){z.getInstance().applicationSettings.socketConnected=!0,A.fireCallback(c,B.OPEN_SOCKET,"")},c.socket.onmessage=function(a){var b=JSON.parse(a.data);b.ui_response?A.processResponse(c,b):b.ui_notification&&A.processNotification(c,b)},c.socket.onclose=function(){A.fireCallback(c,B.CLOSE_SOCKET,""),z.getInstance().applicationSettings.socketConnected=!1}):console.warn("AgentLibrary: WebSocket NOT supported by your Browser.")},b.prototype.closeSocket=function(){this.socket.close()}}function k(a){"use strict";var b=a.AgentLibrary;b.prototype.loginAgent=function(a,b,c){z.getInstance().loginRequest=new p(a,b);var d=z.getInstance().loginRequest.formatJSON();A.setCallback(this,B.LOGIN,c),A.sendMessage(this,d)},b.prototype.configureAgent=function(a,b,c,d,e,f,g){z.getInstance().configRequest=new o(a,b,c,d,e,f);var h=z.getInstance().configRequest.formatJSON();A.setCallback(this,B.CONFIG,g),A.sendMessage(this,h)},b.prototype.logoutAgent=function(a,b){if(z.getInstance().logoutRequest=new q(a),A.setCallback(this,B.LOGOUT,b),z.getInstance().logoutRequest.isSupervisor){var c=z.getInstance().logoutRequest.formatJSON();A.sendMessage(this,c)}else A.fireCallback(this,B.LOGOUT,""),this.closeSocket()},b.prototype.setAgentState=function(a,b,c){z.getInstance().agentStateRequest=new l(a,b);var d=z.getInstance().agentStateRequest.formatJSON();A.setCallback(this,B.AGENT_STATE,c),A.sendMessage(this,d)},b.prototype.offhookInit=function(a){z.getInstance().offhookInitRequest=new r;var b=z.getInstance().offhookInitRequest.formatJSON();A.setCallback(this,B.OFFHOOK_INIT,a),A.sendMessage(this,b)},b.prototype.offhookTerm=function(a){z.getInstance().offhookTermRequest=new s;var b=z.getInstance().offhookTermRequest.formatJSON();A.setCallback(this,B.OFFHOOK_TERM,a),A.sendMessage(this,b)},b.prototype.getPendingCallbacks=function(a,b){z.getInstance().callbacksPendingRequest=new n(a);var c=z.getInstance().callbacksPendingRequest.formatJSON();A.setCallback(this,B.CALLBACK_PENDING,b),A.sendMessage(this,c)},b.prototype.cancelCallback=function(a,b,c){z.getInstance().callbackCancelRequest=new m(a,b);var d=z.getInstance().callbackCancelRequest.formatJSON();A.setCallback(this,B.CALLBACK_CANCEL,c),A.sendMessage(this,d)}}var l=function(a,b){"ON-BREAK"==a.toUpperCase()&&1==z.getInstance().onCall?(this.agentState="BREAK-AFTER-CALL",this.agentAuxState=""):(this.agentState=a.toUpperCase()||"",this.agentAuxState=b||"")};l.prototype.formatJSON=function(){var a={ui_request:{"@destination":"IQ","@type":C.AGENT_STATE,"@message_id":A.getMessageId(),response_to:"",agent_id:{"#text":z.getInstance().agentSettings.agentId},state:{"#text":this.agentState},agent_aux_state:{"#text":this.agentAuxState}}};return JSON.stringify(a)},l.prototype.processResponse=function(a){var b=a.ui_response,c=A.getText(b,"status"),d=A.getText(b,"prev_state"),e=A.getText(b,"current_state"),f=A.getText(b,"prev_aux_state"),g=A.getText(b,"agent_aux_state"),h=z.getInstance(),i=A.buildDefaultResponse(a);if(i.agentId=a.ui_response.agent_id["#text"]||"",i.previousState=d,i.currentState=e,i.previousAuxState=f,i.currentAuxState=g,"OK"==c){var j=d,k=e;f.length>0&&(j=f),g.length>0&&(k=g),console.log("AgentLibrary: Agent state changed from ["+j+"] to ["+k+"]"),h.agentSettings.currentState=e,h.agentSettings.currentStateLabel=g,h.agentStatePacket=a}else""===i.message&&(i.message="Unable to change agent state"),console.warn("AgentLibrary: Unable to change agent state "+detail);return i};var m=function(a,b){this.agentId=b||z.getInstance().agentSettings.agentId,this.leadId=a};m.prototype.formatJSON=function(){var a={ui_request:{"@destination":"IQ","@type":C.CALLBACK_CANCEL,"@message_id":A.getMessageId(),response_to:"",agent_id:{"#text":this.agentId},lead_id:{"#text":this.leadId}}};return JSON.stringify(a)};var n=function(a){this.agentId=a||z.getInstance().agentSettings.agentId};n.prototype.formatJSON=function(){var a={ui_request:{"@destination":"IQ","@type":C.CALLBACK_PENDING,"@message_id":A.getMessageId(),response_to:"",agent_id:{"#text":this.agentId}}};return JSON.stringify(a)},n.prototype.processResponse=function(a){var c=a.ui_response.lead,d=[];if(Array.isArray(c))for(var e=0;e<c.length;e++){var f=c[e],g=b(f);d.push(g)}else c&&d.push(b(c));return z.getInstance().agentSettings.pendingCallbacks=JSON.parse(JSON.stringify(d)),z.getInstance().agentSettings.pendingCallbacks};var o=function(a,b,c,d,e,f){this.queueIds=a||[],this.chatIds=b||[],this.skillPofileId=c||"",this.dialGroupId=d||"",this.dialDest=e||"",this.updateFromAdminUI=f||!1,this.loginType="NO-SELECTION",this.updateLogin=!1;var g=z.getInstance();this.queueIds=A.checkExistingIds(g.inboundSettings.availableQueues,this.queueIds,"gateId"),this.chatIds=A.checkExistingIds(g.chatSettings.availableChatQueues,this.chatIds,"chatQueueId"),this.skillPofileId=A.checkExistingIds(g.inboundSettings.availableSkillProfiles,[this.skillPofileId],"profileId")[0]||"",this.dialGroupId=A.checkExistingIds(g.outboundSettings.availableOutdialGroups,[this.dialGroupId],"dialGroupId")[0]||"",this.queueIds.length>0&&""!==this.dialGroupId?this.loginType="BLENDED":this.queueIds.length>0?this.loginType="INBOUND":""!==this.dialGroupId?this.loginType="OUTBOUND":this.loginType="NO-SELECTION",g.agentSettings.isLoggedIn&&(this.updateLogin=!0),A.validateDest(this.dialDest)||console.error("AgentLibrary: dialDest must be a valid sip or 10-digit DID")};o.prototype.formatJSON=function(){for(var a={ui_request:{"@destination":"IQ","@type":C.LOGIN,"@message_id":A.getMessageId(),response_to:"",agent_id:{"#text":A.toString(z.getInstance().agentSettings.agentId)},agent_pwd:{"#text":z.getInstance().loginRequest.password},dial_dest:{"#text":A.toString(this.dialDest)},login_type:{"#text":this.loginType},update_login:{"#text":A.toString(this.updateLogin)},outdial_group_id:{"#text":A.toString(this.dialGroupId)},skill_profile_id:{"#text":A.toString(this.skillPofileId)},update_from_adminui:{"#text":A.toString(this.updateFromAdminUI)}}},b=[],c=0;c<this.queueIds.length;c++)""!==this.queueIds[c]&&b.push({"#text":A.toString(this.queueIds[c])});b.length>0?a.ui_request.gates={gate_id:b}:a.ui_request.gates={};for(var d=[],c=0;c<this.chatIds.length;c++)""!==this.chatIds[c]&&d.push({"#text":A.toString(this.chatIds[c])});return d.length>0?a.ui_request.chat_queues={chat_queue_id:d}:a.ui_request.chat_queues={},JSON.stringify(a)},o.prototype.processResponse=function(a){var b=a.ui_response,g=A.getText(b,"status"),h=A.getText(b,"detail"),i=z.getInstance(),j=A.buildDefaultResponse(a);return"Logon Session Configuration Updated!"===h&&(i.agentSettings.updateLoginMode=!0),"SUCCESS"===g?(i.agentSettings.isLoggedIn?i.agentSettings.updateLoginMode?(i.agentSettings.updateLoginMode=!1,i.agentPermissions.allowLeadSearch=!1,i.agentPermissions.requireFetchedLeadsCalled=!1,i.agentPermissions.allowPreviewLeadFilters=!1,c(a),d(),e(),f()):console.log("AgentLibrary: Processed a Layer 2 Reconnect Successfully"):(i.configPacket=a,i.connectionSettings.hashCode=A.getText(b,"hash_code"),i.agentSettings.isLoggedIn=!0,i.agentSettings.loginDTS=new Date,i.connectionSettings.reconnect=!0,i.agentPermissions.allowLeadSearch=!1,i.agentSettings.dialDest=i.configRequest.dialDest,i.agentSettings.loginType=A.getText(b,"login_type"),c(a),d(),e(),f()),j.agentSettings=i.agentSettings,j.agentPermissions=i.agentPermissions,j.applicationSettings=i.applicationSettings,j.chatSettings=i.chatSettings,j.connectionSettings=i.connectionSettings,j.inboundSettings=i.inboundSettings,j.outboundSettings=i.outboundSettings,j.surveySettings=i.surveySettings):(""===j.message&&(j.message="Agent configuration attempt failed (2nd layer login)"),console.warn("AgentLibrary: Layer 2 login failed!")),j};var p=function(a,b){this.username=a,this.password=b};p.prototype.formatJSON=function(){var a={ui_request:{"@destination":"IS","@type":C.LOGIN,"@message_id":A.getMessageId(),response_to:"",username:{"#text":this.username},password:{"#text":this.password}}};return JSON.stringify(a)},p.prototype.processResponse=function(a){var b=a.ui_response,c=b.status["#text"],d=z.getInstance(),e=A.buildDefaultResponse(a);if("OK"===c){if(!d.isLoggedInIS){d.loginPacket=a,d.applicationSettings.isLoggedInIS=!0,d.applicationSettings.isTcpaSafeMode="1"===A.getText(b,"tcpa_safe_mode"),d.chatSettings.alias=A.getText(b,"first_name")+" "+A.getText(b,"last_name"),d.agentSettings.loginDTS=new Date,d.agentSettings.maxBreakTime=A.getText(b,"max_break_time"),d.agentSettings.maxLunchTime=A.getText(b,"max_lunch_time"),d.agentSettings.firstName=A.getText(b,"first_name"),d.agentSettings.lastName=A.getText(b,"last_name"),d.agentSettings.email=A.getText(b,"email"),d.agentSettings.agentId=A.getText(b,"agent_id"),d.agentSettings.externalAgentId=A.getText(b,"external_agent_id"),d.agentSettings.agentType=A.getText(b,"agent_type"),d.agentSettings.realAgentType=A.getText(b,"real_agent_type"),d.agentSettings.defaultLoginDest=A.getText(b,"default_login_dest"),d.agentSettings.altDefaultLoginDest=A.getText(b,"alt_default_login_dest"),d.agentSettings.disableSupervisorMonitoring=A.getText(b,"disable_supervisor_monitoring"),d.agentSettings.initLoginState=A.getText(b,"init_login_state"),d.agentSettings.initLoginStateLabel=A.getText(b,"init_login_state_label"),d.agentSettings.outboundManualDefaultRingtime=A.getText(b,"outbound_manual_default_ringtime"),d.agentSettings.isOutboundPrepay="1"===A.getText(b,"outbound_prepay"),d.agentPermissions.allowCallControl="1"===A.getText(b,"allow_call_control"),d.agentPermissions.allowChat="1"===A.getText(b,"allow_chat"),d.agentPermissions.showLeadHistory="1"===A.getText(b,"show_lead_history"),d.agentPermissions.allowManualOutboundGates="1"===A.getText(b,"allow_manual_outbound_gates"),d.agentPermissions.allowOffHook="1"===A.getText(b,"allow_off_hook"),d.agentPermissions.allowManualCalls="1"===A.getText(b,"allow_manual_calls"),d.agentPermissions.allowManualPass="1"===A.getText(b,"allow_manual_pass"),d.agentPermissions.allowManualIntlCalls="1"===A.getText(b,"allow_manual_intl_calls"),d.agentPermissions.allowLoginUpdates="1"===A.getText(b,"allow_login_updates"),d.agentPermissions.allowInbound="1"===A.getText(b,"allow_inbound"),d.agentPermissions.allowOutbound="1"===A.getText(b,"allow_outbound"),d.agentPermissions.allowBlended="1"===A.getText(b,"allow_blended"),d.agentPermissions.allowLoginControl="1"===A.getText(b,"allow_login_control"),d.agentPermissions.allowCrossQueueRequeue="1"===A.getText(b,"allow_cross_gate_requeue");var f="undefined"==typeof b.insert_campaigns?!1:a.ui_response.insert_campaigns.campaign;f&&f.length>0&&(d.agentPermissions.allowLeadInserts=!0),processCampaigns(a),d.chatSettings.availableChatQueues=A.processResponseCollection(a.ui_response,"login_chat_queues","chat_queue"),d.inboundSettings.availableQueues=A.processResponseCollection(a.ui_response,"login_gates","gate"),d.inboundSettings.availableSkillProfiles=A.processResponseCollection(a.ui_response,"skill_profiles","profile"),d.inboundSettings.availableRequeueQueues=A.processResponseCollection(a.ui_response,"requeue_gates","gate_group"),d.chatSettings.availableChatRooms=A.processResponseCollection(a.ui_response,"chat_rooms","room"),d.surveySettings.availableSurveys=A.processResponseCollection(a.ui_response,"surveys","survey"),d.agentSettings.callerIds=A.processResponseCollection(a.ui_response,"caller_ids","caller_id"),d.agentSettings.availableAgentStates=A.processResponseCollection(a.ui_response,"agent_states","agent_state"),d.applicationSettings.availableCountries=A.processResponseCollection(a.ui_response,"account_countries","country"),d.outboundSettings.insertCampaigns=A.processResponseCollection(a.ui_response,"insert_campaigns","campaign");for(var g=A.processResponseCollection(a.ui_response,"outdial_groups","group"),h=0;h<g.length;h++){var i=g[h];i.allowLeadSearch="YES"===i.allowLeadSearch,i.allowPreviewLeadFilters="1"===i.allowPreviewLeadFilters,i.progressiveEnabled="1"===i.progressiveEnabled,i.requireFetchedLeadsCalled="1"===i.requireFetchedLeadsCalled}d.outboundSettings.availableOutdialGroups=g}e.agentSettings=d.agentSettings,e.agentPermissions=d.agentPermissions,e.applicationSettings=d.applicationSettings,e.chatSettings=d.chatSettings,e.connectionSettings=d.connectionSettings,e.inboundSettings=d.inboundSettings,e.outboundSettings=d.outboundSettings,e.surveySettings=d.surveySettings}else"RESTRICTED"===c?(e.message="Invalid IP Address",console.log("AgentLibrary: Invalid IP Address")):(e.message="Invalid Username or password",console.log("AgentLibrary: Invalid Username or password"));return e},processCampaigns=function(a){var b=[],c={},d=[],e=[],f=[],g="",h=0,i="",j=!1;if("undefined"!=typeof a.ui_response.campaigns.campaign&&(d=a.ui_response.campaigns.campaign),Array.isArray(d))for(var k=0;k<d.length;k++){h=d[k]["@campaign_id"],i=d[k]["@campaign_name"],j="1"==d[k]["@allow_lead_updates"],e=d[k].custom_labels,f=[],g="",z.getInstance().agentPermissions.allowLeadUpdatesByCampaign[h]=j;for(var l in e){g=l.replace(/@/,"");var m={};m[g]=e[l],f.push(m)}c={allowLeadUpdates:j,campaignId:h,campaignName:i,surveyId:d[k]["@survey_id"],surveyName:d[k]["@survey_name"],customLabels:f},b.push(c)}else if(d){h=d["@campaign_id"],i=d["@campaign_name"],j="1"==d["@allow_lead_updates"],e=d.custom_labels,f=[],g="",z.getInstance().agentPermissions.allowLeadUpdatesByCampaign[h]=j;for(var n in e){g=n.replace(/@/,"");var m={};m[g]=e[n],f.push(m)}c={allowLeadUpdates:j,campaignId:h,campaignName:i,surveyId:d["@survey_id"],surveyName:d["@survey_name"],customLabels:f},b.push(c)}z.getInstance().outboundSettings.availableCampaigns=b};var q=function(a,b,c){this.agentId=a,this.message=b,this.isSupervisor=c};q.prototype.formatJSON=function(){var a={ui_request:{"@destination":"IQ","@type":C.LOGOUT,"@message_id":A.getMessageId(),response_to:"",agent_id:{"#text":this.agentId},message:{"#text":this.message}}};return JSON.stringify(a)};var r=function(){};r.prototype.formatJSON=function(){var a={ui_request:{"@destination":"IQ","@type":C.OFFHOOK_INIT,"@message_id":A.getMessageId(),response_to:"",agent_id:{"#text":z.getInstance().agentSettings.agentId},dial_dest:{"#text":z.getInstance().agentSettings.dialDest}}};return JSON.stringify(a)},r.prototype.processResponse=function(a){var b=a.ui_response.status["#text"],c=A.buildDefaultResponse(a);return"OK"===b?(z.getInstance().offhookInitPacket=a,z.getInstance().agentSettings.isOffhook=!0):(""===c.message&&(c.message="Unable to process offhook request"),console.log("AgentLibrary: Unable to process offhook request ",detail)),c};var s=function(a){};s.prototype.formatJSON=function(){var a={ui_request:{"@destination":"IQ","@type":C.OFFHOOK_TERM,"@message_id":A.getMessageId(),response_to:"",agent_id:{"#text":z.getInstance().agentSettings.agentId}}};return JSON.stringify(a)},s.prototype.processResponse=function(a){var b=a.ui_notification,c="1"===A.getText(b,"monitoring"),d=z.getInstance();d.agentSettings.wasMonitoring=c,d.offhookTermPacket=a,d.agentSettings.isOffhook=!1;var e={agentId:A.getText(b,"agent_id"),startDts:A.getText(b,"start_dts"),endDts:A.getText(b,"end_dts"),monitoring:c};return e};var t=function(){};t.prototype.processResponse=function(a){var b=z.getInstance(),c=a.ui_notification,d=b.configRequest.loginType,e=A.getText(c,"dial_group_id");b.dialGroupChangeNotification=a,!e||""===e||"INBOUND"!==d&&"BLENDED"!==d?e&&""!==e?b.configRequest.loginType="OUTBOUND":"INBOUND"===d?b.configRequest.loginType="INBOUND":b.configRequest.loginType="NO-SELECTION":b.configRequest.loginType="BLENDED",z.getInstance().configRequest.dialGroupId=e;var f={message:"Dial Group Updated Successfully.",detail:"Dial Group changed to ["+e+"].",dialGroupId:A.getText(c,"dial_group_id"),dialGroupName:A.getText(c,"dialGroupName"),dialGroupDesc:A.getText(c,"dial_group_desc"),agentId:A.getText(c,"agent_id")};return f};var u=function(){};u.prototype.processResponse=function(a){var b=z.getInstance(),c=a.ui_notification;b.agentSettings.pendingDialGroupChange=parseInt(A.getText(c,"dial_group_id"),10),c.update_from_adminui?b.agentSettings.updateDGFromAdminUI=A.getText(c,"update_from_adminui")===!0:b.agentSettings.updateDGFromAdminUI=!1;var d={message:"Dial Group Change Pending notification received.",detail:"DialGroup switch for existing session pending until active call ends.",agentId:A.getText(c,"agent_id"),dialGroupId:A.getText(c,"dial_group_id"),updateFromAdminUI:A.getText(c,"update_from_adminui")};return d};var v=function(a){this.libInstance=a};v.prototype.processResponse=function(a){var b=z.getInstance(),c=a.ui_notification;b.endCallNotification=a,b.currentCall.duration=A.getText(c,"call_duration"),b.currentCall.termParty=A.getText(c,"term_party"),b.currentCall.termReason=A.getText(c,"term_reason"),b.agentSettings.callState="CALL-ENDED",b.transferSessions={},(b.agentSettings.pendingDialGroupChange>0||-1==b.agentSettings.pendingDialGroupChange)&&(b.configRequest.dialGroupId=b.agentSettings.pendingDialGroupChange,this.libInstance.configureAgent(b.configRequest.queueIds,b.configRequest.chatIds,b.configRequest.skillProfileId,b.configRequest.dialGroupId,b.configRequest.dialDest,b.agentSettings.updateDGFromAdminUI),b.agentSettings.pendingDialGroupChange=0,b.agentSettings.updateDGFromAdminUI=!1);var d={message:"End Call Notification Received.",detail:"",uii:A.getText(c,"uii"),sessionId:A.getText(c,"session_id"),agentId:A.getText(c,"agent_id"),callDts:A.getText(c,"call_dts"),duration:b.currentCall.duration,termParty:b.currentCall.termParty,termReason:b.currentCall.termReason,recordingUrl:A.getText(c,"recording_url"),dispositionTimeout:A.getText(c,"disposition_timeout")};return d};var w=function(){};w.prototype.processResponse=function(a){var b=z.getInstance(),c=a.ui_notification,d=[],e=b.inboundSettings.availableQueues,f=A.getText(c,"gate_ids");""!==f&&(f=f.split(","));for(var g=0;g<f.length;g++){var h=f[g],i=A.findObjById(e,h,"gateId");if(i)d.push(i);else{var j={gateId:h,gateName:"",gateDesc:"",defaultDestOverride:"",isAgentSelectable:!1};d.push(j)}}b.inboundSettings.queues=JSON.parse(JSON.stringify(d));var k={agentId:A.getText(c,"agent_id"),message:"Gates Change notification received.",queues:d};return k};var x=function(){};x.prototype.processResponse=function(a){var b=A.buildDefaultResponse(a);return b.messageCode=A.getText(a.ui_notification,"message_code"),b};var y=function(){};y.prototype.processResponse=function(a){var b=z.getInstance(),c=a.ui_notification,d={uii:A.getText(c,"uii"),agentId:A.getText(c,"agent_id"),dialDest:A.getText(c,"dial_dest"),queueDts:A.getText(c,"queue_dts"),queueTime:A.getText(c,"queue_time"),ani:A.getText(c,"ani"),dnis:A.getText(c,"dnis"),callType:A.getText(c,"call_type"),appUrl:A.getText(c,"app_url"),isMonitoring:A.getText(c,"is_monitoring"),allowHold:A.getText(c,"allow_hold"),allowTransfer:A.getText(c,"allow_transfer"),allowHangup:A.getText(c,"allow_hangup"),allowRequeue:A.getText(c,"allow_requeue"),allowEndCallForEveryone:A.getText(c,"allow_endcallforeveryone"),surveyId:A.getText(c,"survey_id"),surveyPopType:A.getText(c,"survey_pop_type"),requeueType:A.getText(c,"requeue_type")};if(d.queue=A.processResponseCollection(a,"ui_notification","gate")[0],d.agentRecording=A.processResponseCollection(a,"ui_notification","agent_recording","agentRecording")[0],d.outdialDispositions=A.processResponseCollection(a,"ui_notification","outdial_dispositions","disposition")[0],d.baggage=A.processResponseCollection(a,"ui_notification","baggage")[0],d.surveyResponse=A.processResponseCollection(a,"ui_notification","survey_response","detail")[0],d.transferPhoneBook=A.processResponseCollection(a,"ui_notification","transfer_phone_book")[0],d.queue.isCampaign="1"===d.queue.isCampaign,"GATE"===d.outdialDispositions.type.toUpperCase())for(var e=0;e<d.outdialDispositions.dispositions.length;e++){var f=d.outdialDispositions.dispositions[e];f.isComplete="1"===f.isComplete,f.requireNote="1"===f.requireNote,f.saveSurvey="1"===f.saveSurvey,f.xfer="1"===f.xfer}return b.tokens=g(c,d),d.isMonitoring?b.agentSettings.callState="ACTIVE-MONITORING":(b.agentSettings.callState="ACTIVE",d.baggage&&""!=d.baggage.auxPhone&&(b.transferNumber=d.baggage.auxPhone)),b.agentDailyStats.currCallTime=0,d};var z=function(){function a(){return{agentStateRequest:null,callbacksPendingRequest:null,configRequest:null,logoutRequest:null,loginRequest:null,offhookInitRequest:null,offhookTermRequest:null,agentStatePacket:null,configPacket:null,currentCallPacket:null,loginPacket:null,offhookInitPacket:null,offhookTermPacket:null,transferSessions:null,dialGroupChangeNotification:new t,dialGroupChangePendingNotification:new u,endCallNotification:new v,gatesChangeNotification:new w,genericNotification:new x,newCallNotification:new y,applicationSettings:{availableCountries:[],isLoggedInIS:!1,socketConnected:!1,socketDest:"",isTcpaSafeMode:!1},currentCall:{},callTokens:{},agentDailyStats:{loginTime:0,offhookTime:0,talkTime:0,currCallTime:0},agentSettings:{agentId:0,agentType:"AGENT",altDefaultLoginDest:"",availableAgentStates:[],callerIds:[],callState:null,currentState:"OFFLINE",currentStateLabel:"",defaultLoginDest:"",dialDest:"",email:"",externalAgentId:"",firstName:"",isLoggedIn:!1,isOffhook:!1,initLoginState:"AVAILABLE",initLoginStateLabel:"Available",isOutboundPrepay:!1,lastName:"",loginDTS:null,loginType:"NO-SELECTION",maxBreakTime:-1,maxLunchTime:-1,onCall:!1,outboundManualDefaultRingtime:"30",pendingCallbacks:[],pendingDialGroupChange:0,realAgentType:"AGENT",transferNumber:"",updateDGFromAdminUI:!1,updateLoginMode:!1,wasMonitoring:!1},agentPermissions:{allowBlended:!0,allowCallControl:!0,allowChat:!1,allowCrossQueueRequeue:!1,allowInbound:!0,allowLeadInserts:!1,allowLeadSearch:!1,allowLoginControl:!0,allowLoginUpdates:!0,allowManualCalls:!0,allowManualPass:!0,allowManualIntlCalls:!1,allowManualOutboundGates:!1,allowOffHook:!0,allowOutbound:!0,allowPreviewLeadFilters:!1,allowLeadUpdatesByCampaign:{},disableSupervisorMonitoring:!0,requireFetchedLeadsCalled:!1,showLeadHistory:!0},chatSettings:{availableChatQueues:[],availableChatRooms:[],chatQueues:[],alias:""},connectionSettings:{hashCode:null,reconnect:!1},inboundSettings:{availableQueues:[],availableSkillProfiles:[],queues:[],skillProfile:{}},outboundSettings:{availableCampaigns:[],availableOutdialGroups:[],insertCampaigns:[],outdialGroup:{}},surveySettings:{availableSurveys:[]}}}var b;return{getInstance:function(){return b||(b=a()),b}}}(),A={sendMessage:function(a,b){if(1===a.socket.readyState){var c=JSON.parse(b);a._requests[c.ui_request["@message_id"]]={type:c.ui_request["@type"],msg:c.ui_request},a.socket.send(b)}else console.warn("AgentLibrary: WebSocket is not connected, cannot send message.")},processResponse:function(a,b){var c=b.ui_response["@type"],d=b.ui_response["@message_id"],e=""===d?"IS":d.slice(0,2);switch(console.log("AgentLibrary: received response: ("+e+") "+c.toUpperCase()),A.fireCallback(a,B.ON_MESSAGE,b),c.toUpperCase()){case C.LOGIN:if("IS"===e){var f=z.getInstance().loginRequest.processResponse(b);A.fireCallback(a,B.LOGIN,f)}else if("IQ"===e){var g=z.getInstance().configRequest.processResponse(b);A.fireCallback(a,B.CONFIG,g)}break;case C.LOGOUT:A.fireCallback(a,B.LOGOUT,b);break;case C.AGENT_STATE:null===z.getInstance().agentStateRequest&&(z.getInstance().agentStateRequest=new l(b.ui_response.current_state["#text"],b.ui_response.agent_aux_state["#text"]));var h=z.getInstance().agentStateRequest.processResponse(b);A.fireCallback(a,B.AGENT_STATE,h);break;case C.OFFHOOK_INIT:var i=z.getInstance().offhookInitRequest.processResponse(b);A.fireCallback(a,B.OFFHOOK_INIT,i);break;case C.CALLBACK_PENDING:var j=z.getInstance().callbacksPendingRequest.processResponse(b);A.fireCallback(a,B.CALLBACK_PENDING,j)}},processNotification:function(a,b){var c=b.ui_notification["@type"],d=b.ui_notification["@message_id"],e=""===d?"IS":d.slice(0,2);switch(console.log("AgentLibrary: received notification: ("+e+") "+c.toUpperCase()),c.toUpperCase()){case C.GATES_CHANGE:var f=new w,g=f.processResponse(b);A.fireCallback(a,B.GATES_CHANGE,g);break;case C.DIAL_GROUP_CHANGE:var h=new t,i=h.processResponse(b);A.fireCallback(a,B.DIAL_GROUP_CHANGE,i);break;case C.DIAL_GROUP_CHANGE_PENDING:var j=new u,k=j.processResponse(b);A.fireCallback(a,B.DIAL_GROUP_CHANGE_PENDING,k);break;case C.NEW_CALL:var l=new y(a),m=l.processResponse(b);A.fireCallback(a,B.NEW_CALL,m);break;case C.END_CALL:var n=new v(a),o=n.processResponse(b);A.fireCallback(a,B.END_CALL,o);break;case C.GENERIC:var p=new x,q=p.processResponse(b),r=b.ui_notification["@response_to"];if(a._requests[r]){var c=a._requests[r].type,D=A.findCallbackBasedOnMessageType(c);A.fireCallback(a,D,q)}else A.fireCallback(a,B.GENERIC_NOTIFICATION,q);break;case C.OFFHOOK_TERM:null===z.getInstance().offhookTermRequest&&(z.getInstance().offhookTermRequest=new s);var E=z.getInstance().offhookTermRequest.processResponse(b);A.fireCallback(a,B.OFFHOOK_TERM,E)}},processResponseCollection:function(a,b,c,d){var e=[],f={},g=[],d=d||"text";if(a[b]&&"undefined"!=typeof a[b][c]&&(g=a[b][c]),Array.isArray(g))for(var h=0;h<g.length;h++){var i="";for(var j in g[h])if(j.match(/^#/)?i=d:(i=j.replace(/@/,""),
i=i.replace(/_([a-z])/g,function(a){return a[1].toUpperCase()})),"object"==typeof g[h][j])if(g[h][j]["#text"])f[j]=g[h][j]["#text"];else if(0===Object.keys(g[h][j]).length)f[j]="";else if(Array.isArray(g[j])){var k=[];k=A.processResponseCollection(a[b],c,j,d),f[i+"s"]=k}else{var l=Object.keys(g[h][j])[0],m=[];m=A.processResponseCollection(g[h],j,l),f[i]=m}else"TRUE"===g[h][j].toUpperCase()?f[i]=!0:"FALSE"===g[h][j].toUpperCase()?f[i]=!1:f[i]=g[h][j];e.push(f),f={}}else{var n="";for(var o in g)if(o.match(/^#/)?n=d:(n=o.replace(/@/,""),n=n.replace(/_([a-z])/g,function(a){return a[1].toUpperCase()})),"object"==typeof g[o])if(g[o]["#text"])f[o]=g[o]["#text"];else if(0===Object.keys(g[o]).length)f[o]="";else if(Array.isArray(g[o])){var k=[];k=A.processResponseCollection(a[b],c,o,d),f[n+"s"]=k}else{var p=Object.keys(g[o])[0],q=[];q=A.processResponseCollection(g,o,p),f[n]=q}else"TRUE"===g[o].toUpperCase()?f[n]=!0:"FALSE"===g[o].toUpperCase()?f[n]=!1:f[n]=g[o];e.push(f)}return e},fireCallback:function(a,b,c){c=c||"","function"==typeof a.callbacks[b]&&a.callbacks[b].call(a,c)},setCallback:function(a,b,c){"undefined"!=typeof c&&(a.callbacks[b]=c)},getMessageId:function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},checkExistingIds:function(a,b,c){for(var d=[],e=[],f=0;f<a.length;f++)d.push(parseInt(a[f][c],10));for(var g=0;g<b.length;g++)-1===d.indexOf(parseInt(b[g],10))&&e.push(parseInt(b[g],10));for(var h=b.length-1;h>=0;h--)e.indexOf(parseInt(b[h],10))>-1&&b.splice(h,1);return b},findObjById:function(a,b,c){for(var d=0;d<a.length;d++){var e=a[d];if(e[c]===b)return e}return null},validateDest:function(a){var b=!1,c=/^\d+$/.test(a);return c&&10===a.length?b=!0:"sip:"===a.slice(0,4).toLowerCase()&&-1!==a.indexOf("@")&&(b=!0),b},findCallbackBasedOnMessageType:function(a){var b="";for(key in C)C[key]===a&&(b=B[key]);return b},buildDefaultResponse:function(a){var b="",c="",d="",e="",f="",g="";return a.ui_response?(e=a.ui_response.message,f=a.ui_response.detail,g=a.ui_response.status):a.ui_notification&&(e=a.ui_notification.message,f=a.ui_notification.detail,g=a.ui_notification.status),e&&(b=e["#text"]||""),f&&(c=f["#text"]||""),g&&(d=g["#text"]||""),{message:b,detail:c,status:d}},toString:function(a){return a?a.toString():""},getText:function(a,b){var c=a[b];return c&&c["#text"]?"TRUE"===c["#text"].toUpperCase()?!0:"FALSE"===c["#text"].toUpperCase()?!1:c["#text"]||"":""},parseKeyValuePairsFromString:function(a,b,c){if(!a)return[];for(var d=[],e=a.split(b),f=0;f<e.length;f++){var g=e[f],h=g.split(c),i={};i[h[0]]=h[1],d.push(i)}return d}};const B={AGENT_STATE:"agentStateResponse",CLOSE_SOCKET:"closeResponse",CONFIG:"configureResponse",CALLBACK_PENDING:"callbacksPendingResponse",CALLBACK_CANCEL:"callbackCancelResponse",DIAL_GROUP_CHANGE:"dialGroupChangeNotification",DIAL_GROUP_CHANGE_PENDING:"dialGroupChangePendingNotification",END_CALL:"endCallNotification",GATES_CHANGE:"gatesChangeNotification",GENERIC_NOTIFICATION:"genericNotification",GENERIC_RESPONSE:"genericResponse",LOGIN:"loginResponse",NEW_CALL:"newCallNotification",OFFHOOK_INIT:"offhookInitResponse",OFFHOOK_TERM:"offhookTermResponse",OPEN_SOCKET:"openResponse"},C={LOGIN:"LOGIN",LOGOUT:"LOGOUT",AGENT_STATE:"AGENT-STATE",CALLBACK_PENDING:"PENDING-CALLBACKS",CALLBACK_CANCEL:"CANCEL-CALLBACK",END_CALL:"END-CALL",DIAL_GROUP_CHANGE:"DIAL_GROUP_CHANGE",DIAL_GROUP_CHANGE_PENDING:"DIAL_GROUP_CHANGE_PENDING",GATES_CHANGE:"GATES_CHANGE",GENERIC:"GENERIC",NEW_CALL:"NEW-CALL",OFFHOOK_INIT:"OFF-HOOK-INIT",OFFHOOK_TERM:"OFF-HOOK-TERM",ON_MESSAGE:"ON-MESSAGE"};var D=function(a){return i(a),j(a),k(a),a.AgentLibrary};"function"==typeof define&&define.amd?(console.log("AgentLibrary: using AMD"),define(function(){return D({})})):"object"==typeof module&&module.exports?(console.log("AgentLibrary: Using Node"),module.exports=D(this)):(console.log("AgentLibrary: Not using AMD"),D(this))}(this);