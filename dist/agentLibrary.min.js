/*! cf-agent-library - v0.0.0 - 2016-07-28 - Connect First */
!function(a){function b(a){for(var b=m.getInstance().outboundSettings.availableOutdialGroups,c=0;c<b.length;c++){var d=b[c];d.dialGroupId===a.ui_response.outdial_group_id["#text"]&&(m.getInstance().agentPermissions.allowLeadSearch=d.allowLeadSearch,m.getInstance().agentPermissions.allowPreviewLeadFilters=d.allowPreviewLeadFilters,m.getInstance().outboundSettings.outdialGroup=JSON.parse(JSON.stringify(d)),m.getInstance().agentPermissions.requireFetchedLeadsCalled=d.requireFetchedLeadsCalled)}}function c(){for(var a=m.getInstance().inboundSettings.availableQueues,b=m.getInstance().configRequest.queueIds,c=[],d=0;d<a.length;d++){var e=a[d];b.indexOf(e.gateId)>-1&&c.push(e)}m.getInstance().inboundSettings.queues=JSON.parse(JSON.stringify(c))}function d(){for(var a=m.getInstance().chatSettings.availableChatQueues,b=m.getInstance().configRequest.chatIds,c=[],d=0;d<a.length;d++){var e=a[d];b.indexOf(e.chatQueueId)>-1&&c.push(e)}m.getInstance().chatSettings.chatQueues=JSON.parse(JSON.stringify(c))}function e(){for(var a=m.getInstance().inboundSettings.availableSkillProfiles,b=0;b<a.length;b++){var c=a[b];c.skillProfileId===m.getInstance().configRequest.skillProfileId&&(m.getInstance().inboundSettings.skillProfile=JSON.parse(JSON.stringify(c)))}}function f(a){"use strict";var b=a.AgentLibrary=function(a){return a=a||{},this.callbacks={},"undefined"!=typeof a.callbacks&&(this.callbacks=a.callbacks),"undefined"!=typeof a.socketDest&&(m.getInstance().socketDest=a.socketDest,this.openSocket()),this};b.prototype.setCallbacks=function(a){for(var b in a)this.callbacks[b]=a[b]},b.prototype.setCallback=function(a,b){this.callbacks[a]=b},b.prototype.getCallbacks=function(){return this.callbacks},b.prototype.getCallback=function(a){return this.callbacks[a]},b.prototype.getLoginRequest=function(){return m.getInstance().loginRequest},b.prototype.getConfigRequest=function(){return m.getInstance().configRequest},b.prototype.getLogoutRequest=function(){return m.getInstance().logoutRequest},b.prototype.getAgentStateRequest=function(){return m.getInstance().agentStateRequest},b.prototype.getLoginPacket=function(){return m.getInstance().loginPacket},b.prototype.getConfigPacket=function(){return m.getInstance().configPacket},b.prototype.getAgentStatePacket=function(){return m.getInstance().agentStatePacket},b.prototype.getCurrentCallPacket=function(){return m.getInstance().currentCallPacket},b.prototype.getApplicationSettings=function(){return m.getInstance().applicationSettings},b.prototype.getChatSettings=function(){return m.getInstance().chatSettings},b.prototype.getInboundSettings=function(){return m.getInstance().inboundSettings},b.prototype.getOutboundSettings=function(){return m.getInstance().outboundSettings},b.prototype.getAgentSettings=function(){return m.getInstance().agentSettings},b.prototype.getAgentPermissions=function(){return m.getInstance().agentPermissions}}function g(a){"use strict";var b=a.AgentLibrary;b.prototype.openSocket=function(b){var c=this;n.setCallback(c,o.OPEN_SOCKET,b),"WebSocket"in a?(console.log("AgentLibrary: attempting to open socket connection..."),c.socket=new WebSocket(m.getInstance().socketDest),m.getInstance().socketConnected=!0,c.socket.onopen=function(){n.fireCallback(c,o.OPEN_SOCKET,"")},c.socket.onmessage=function(a){n.processMessage(c,JSON.parse(a.data))},c.socket.onclose=function(){n.fireCallback(c,o.CLOSE_SOCKET,""),m.getInstance().socketConnected=!1}):console.warn("AgentLibrary: WebSocket NOT supported by your Browser.")},b.prototype.closeSocket=function(){this.socket.close()}}function h(a){"use strict";var b=a.AgentLibrary;b.prototype.loginAgent=function(a,b,c){m.getInstance().loginRequest=new k(a,b);var d=m.getInstance().loginRequest.formatJSON();n.setCallback(this,o.LOGIN,c),n.sendMessage(this,d)},b.prototype.configureAgent=function(a,b,c,d,e,f){m.getInstance().configRequest=new j(a,b,c,d,e);var g=m.getInstance().configRequest.formatJSON();n.setCallback(this,o.CONFIG,f),n.sendMessage(this,g)},b.prototype.logoutAgent=function(a,b){if(m.getInstance().logoutRequest=new l(a),n.setCallback(this,o.LOGOUT,b),m.getInstance().logoutRequest.isSupervisor){var c=m.getInstance().logoutRequest.formatJSON();n.sendMessage(this,c)}else n.fireCallback(this,o.LOGOUT,""),this.closeSocket()},b.prototype.setAgentState=function(a,b,c){m.getInstance().agentStateRequest=new i(a,b);var d=m.getInstance().agentStateRequest.formatJSON();n.setCallback(this,o.AGENT_STATE,c),n.sendMessage(this,d)}}var i=function(a,b){"ON-BREAK"==a.toUpperCase()&&1==m.getInstance().onCall?(this.agentState="BREAK-AFTER-CALL",this.agentAuxState=""):(this.agentState=a.toUpperCase()||"",this.agentAuxState=b||"")};i.prototype.formatJSON=function(){var a={ui_request:{"@destination":"IQ","@type":p.AGENT_STATE,"@message_id":n.getMessageId(),response_to:"",agent_id:{"#text":m.getInstance().agentSettings.agentId},state:{"#text":this.agentState},agent_aux_state:{"#text":this.agentAuxState}}};return JSON.stringify(a)},i.prototype.processResponse=function(a){var b=a.ui_response.status["#text"],c=a.ui_response.prev_state["#text"],d=a.ui_response.current_state["#text"],e=a.ui_response.prev_aux_state["#text"]||"",f=a.ui_response.agent_aux_state["#text"]||"";if("OK"==b){var g=c,h=d;e.length>0&&(g=e),f.length>0&&(h=f),console.log("AgentLibrary: Agent state changed from ["+g+"] to ["+h+"]"),m.getInstance().agentSettings.currentState=d,m.getInstance().agentSettings.currentStateLabel=f,m.getInstance().agentStatePacket=a}else console.warn("AgentLibrary: Unable to change agent state "+a.detail["#text"])};var j=function(a,b,c,d,e){this.queueIds=a||[],this.chatIds=b||[],this.skillPofileId=c||"",this.outdialGroupId=d||"",this.dialDest=e||"",this.updateFromAdminUI=!1,this.loginType="NO-SELECTION",this.updateLogin=!1,this.queueIds=n.checkExistingIds(m.getInstance().inboundSettings.availableQueues,this.queueIds,"gateId"),this.chatIds=n.checkExistingIds(m.getInstance().chatSettings.availableChatQueues,this.chatIds,"chatQueueId"),this.skillPofileId=n.checkExistingIds(m.getInstance().inboundSettings.availableSkillProfiles,[this.skillPofileId],"profileId")[0]||"",this.outdialGroupId=n.checkExistingIds(m.getInstance().outboundSettings.availableOutdialGroups,[this.outdialGroupId],"dialGroupId")[0]||""};j.prototype.formatJSON=function(){this.queueIds.length>0&&""!==this.outdialGroupId?this.loginType="BLENDED":this.queueIds.length>0?this.loginType="INBOUND":""!==this.outdialGroupId?this.loginType="OUTBOUND":this.loginType="NO-SELECTION",m.getInstance().isLoggedIn&&(this.updateLogin=!0);for(var a={ui_request:{"@destination":"IQ","@type":p.LOGIN,"@message_id":n.getMessageId(),response_to:"",agent_id:{"#text":m.getInstance().agentSettings.agentId},agent_pwd:{"#text":m.getInstance().loginRequest.password},dial_dest:{"#text":this.dialDest},login_type:{"#text":this.loginType},update_login:{"#text":this.updateLogin.toString()},outdial_group_id:{"#text":this.outdialGroupId},skill_profile_id:{"#text":this.skillPofileId},update_from_adminui:{"#text":this.updateFromAdminUI.toString()}}},b=[],c=0;c<this.queueIds.length;c++)""!==this.queueIds[c]&&b.push({"#text":this.queueIds[c]});b.length>0?a.ui_request.gates={gate_id:b}:a.ui_request.gates={};for(var d=[],c=0;c<this.chatIds.length;c++)""!==this.chatIds[c]&&d.push({"#text":this.chatIds[c]});return d.length>0?a.ui_request.chat_queues={chat_queue_id:d}:a.ui_request.chat_queues={},JSON.stringify(a)},j.prototype.processResponse=function(a){var f=a.ui_response.status["#text"];"SUCCESS"===f?m.getInstance().isLoggedIn?m.getInstance().agentSettings.updateLoginMode?(m.getInstance().agentSettings.updateLoginMode=!1,m.getInstance().agentPermissions.allowLeadSearch=!1,m.getInstance().agentPermissions.requireFetchedLeadsCalled=!1,m.getInstance().agentPermissions.allowPreviewLeadFilters=!1,b(a),c(),d(),e()):console.log("AgentLibrary: Processed a Layer 2 Reconnect Successfully"):(m.getInstance().configPacket=a,m.getInstance().connectionSettings.hashCode=a.ui_response.hash_code["#text"],m.getInstance().applicationSettings.message=a.ui_response.message["#text"],m.getInstance().agentSettings.isLoggedIn=!0,m.getInstance().agentSettings.loginDTS=new Date,m.getInstance().connectionSettings.reconnect=!0,m.getInstance().agentPermissions.allowLeadSearch=!1,m.getInstance().agentSettings.dialDest=m.getInstance().configRequest.dialDest,m.getInstance().agentSettings.loginType=a.ui_response.login_type["#text"],b(a),c(),d(),e()):console.warn("AgentLibrary: Layer 2 login failed!")};var k=function(a,b){this.username=a,this.password=b};k.prototype.formatJSON=function(){var a={ui_request:{"@destination":"IS","@type":p.LOGIN,"@message_id":n.getMessageId(),response_to:"",username:{"#text":this.username},password:{"#text":this.password}}};return JSON.stringify(a)},k.prototype.processResponse=function(a){var b=a.ui_response.status["#text"];if("OK"===b){if(!m.getInstance().isLoggedInIS){m.getInstance().loginPacket=a,m.getInstance().applicationSettings.isLoggedInIS=!0,m.getInstance().agentSettings.loginDTS=new Date,m.getInstance().chatSettings.alias=a.ui_response.first_name["#text"]+" "+a.ui_response.last_name["#text"],m.getInstance().agentSettings.maxBreakTime=a.ui_response.max_break_time["#text"],m.getInstance().agentSettings.maxLunchTime=a.ui_response.max_lunch_time["#text"],m.getInstance().agentSettings.firstName=a.ui_response.first_name["#text"],m.getInstance().agentSettings.lastName=a.ui_response.last_name["#text"],m.getInstance().agentSettings.email=a.ui_response.email["#text"],m.getInstance().agentSettings.agentId=a.ui_response.agent_id["#text"],m.getInstance().agentSettings.externalAgentId=a.ui_response.external_agent_id["#text"],m.getInstance().agentSettings.agentType=a.ui_response.agent_type["#text"],m.getInstance().agentSettings.realAgentType=a.ui_response.real_agent_type["#text"],m.getInstance().agentSettings.defaultLoginDest=a.ui_response.default_login_dest["#text"],m.getInstance().agentSettings.altDefaultLoginDest=a.ui_response.alt_default_login_dest["#text"],m.getInstance().agentSettings.disableSupervisorMonitoring=a.ui_response.disable_supervisor_monitoring["#text"],m.getInstance().agentSettings.initLoginState=a.ui_response.init_login_state["#text"],m.getInstance().agentSettings.initLoginStateLabel=a.ui_response.init_login_state_label["#text"],m.getInstance().agentSettings.outboundManualDefaultRingtime=a.ui_response.outbound_manual_default_ringtime["#text"];var c="undefined"==typeof a.ui_response.allow_call_control?!1:a.ui_response.allow_call_control["#text"],d="undefined"==typeof a.ui_response.allow_chat?!1:a.ui_response.allow_chat["#text"],e="undefined"==typeof a.ui_response.show_lead_history?!1:a.ui_response.show_lead_history["#text"],f="undefined"==typeof a.ui_response.allow_manual_outbound_gates?!1:a.ui_response.allow_manual_outbound_gates["#text"],g="undefined"==typeof a.ui_response.tcpa_safe_mode?!1:a.ui_response.tcpa_safe_mode["#text"],h="undefined"==typeof a.ui_response.insert_campaigns?!1:a.ui_response.insert_campaigns.campaign,i="undefined"==typeof a.ui_response.outbound_prepay?!1:a.ui_response.outbound_prepay["#text"];"0"==c&&(m.getInstance().agentPermissions.allowCallControl=!1),"1"==d&&(m.getInstance().agentPermissions.allowChat=!0),"0"==e&&(m.getInstance().agentPermissions.showLeadHistory=!1),"1"==f&&(m.getInstance().agentPermissions.allowManualOutboundGates=!0),"1"==g&&(m.getInstance().applicationSettings.isTcpaSafeMode=!0),h&&h.length>0&&(m.getInstance().agentPermissions.allowLeadInserts=!0),"1"==i&&(m.getInstance().agentSettings.isOutboundPrepay=!0),"0"==a.ui_response.allow_off_hook["#text"]&&(m.getInstance().agentPermissions.allowOffHook=!1),"0"==a.ui_response.allow_manual_calls["#text"]&&(m.getInstance().agentPermissions.allowManualCalls=!1),"0"==a.ui_response.allow_manual_pass["#text"]&&(m.getInstance().agentPermissions.allowManualPass=!1),"1"==a.ui_response.allow_manual_intl_calls["#text"]&&(m.getInstance().agentPermissions.allowManualIntlCalls=!0),"0"==a.ui_response.allow_login_updates["#text"]&&(m.getInstance().agentPermissions.allowLoginUpdates=!1),"0"==a.ui_response.allow_inbound["#text"]&&(m.getInstance().agentPermissions.allowInbound=!1),"0"==a.ui_response.allow_outbound["#text"]&&(m.getInstance().agentPermissions.allowOutbound=!1),"0"==a.ui_response.allow_blended["#text"]&&(m.getInstance().agentPermissions.allowBlended=!1),"0"==a.ui_response.allow_login_control["#text"]&&(m.getInstance().agentPermissions.allowLoginControl=!1),"1"==a.ui_response.allow_cross_gate_requeue["#text"]&&(m.getInstance().agentPermissions.allowCrossQueueRequeue=!0),processCampaigns(a),m.getInstance().chatSettings.availableChatQueues=n.processResponseCollection(a.ui_response,"login_chat_queues","chat_queue"),m.getInstance().inboundSettings.availableQueues=n.processResponseCollection(a.ui_response,"login_gates","gate"),m.getInstance().inboundSettings.availableSkillProfiles=n.processResponseCollection(a.ui_response,"skill_profiles","profile"),m.getInstance().inboundSettings.availableRequeueQueues=n.processResponseCollection(a.ui_response,"requeue_gates","gate_group"),m.getInstance().chatSettings.availableChatRooms=n.processResponseCollection(a.ui_response,"chat_rooms","room"),m.getInstance().surveySettings.availableSurveys=n.processResponseCollection(a.ui_response,"surveys","survey"),m.getInstance().agentSettings.callerIds=n.processResponseCollection(a.ui_response,"caller_ids","caller_id"),m.getInstance().agentSettings.availableAgentStates=n.processResponseCollection(a.ui_response,"agent_states","agent_state"),m.getInstance().applicationSettings.availableCountries=n.processResponseCollection(a.ui_response,"account_countries","country"),m.getInstance().outboundSettings.insertCampaigns=n.processResponseCollection(a.ui_response,"insert_campaigns","campaign");var j=n.processResponseCollection(a.ui_response,"outdial_groups","group");j.allowLeadSearch="YES"==j.allowLeadSearch,j.allowPreviewLeadFilters="1"==j.allowPreviewLeadFilters,j.allowProgressiveEnabled="1"==j.allowProgressiveEnabled,m.getInstance().outboundSettings.availableOutdialGroups=j}}else"RESTRICTED"===b?console.log("AgentLibrary: Invalid IP Address"):console.log("AgentLibrary: Invalid Username or password")},processCampaigns=function(a){var b=[],c={},d=[],e=[],f=[],g="",h=0,i=!1;if("undefined"!=typeof a.ui_response.campaigns.campaign&&(d=a.ui_response.campaigns.campaign),Array.isArray(d))for(var j=0;j<d.length;j++){h=d[j]["@campaign_id"],i="1"==d[j]["@allow_lead_updates"],e=d[j].custom_labels,f=[],g="",m.getInstance().agentPermissions.allowLeadUpdatesByCampaign[h]=i;for(var k in e){g=k.replace(/@/,"");var l={};l[g]=e[k],f.push(l)}c={allowLeadUpdates:i,campaignId:h,surveyId:d[j]["@survey_id"],surveyName:d[j]["@survey_name"],customLabels:f},b.push(c)}else{h=d[j]["@campaign_id"],i="1"==d[j]["@allow_lead_updates"],e=d.custom_labels,f=[],g="",m.getInstance().agentPermissions.allowLeadUpdatesByCampaign[h]=i;for(var n in e){g=n.replace(/@/,"");var l={};l[g]=e[n],f.push(l)}c={allowLeadUpdates:d["@allow_lead_updates"],campaignId:d["@campaign_id"],surveyId:d["@survey_id"],surveyName:d["@survey_name"],customLabels:f},b.push(c)}m.getInstance().outboundSettings.availableCampaigns=b};var l=function(a,b,c){this.agentId=a,this.message=b,this.isSupervisor=c};l.prototype.formatJSON=function(){var a={ui_request:{"@destination":"IQ","@type":p.LOGOUT,"@message_id":n.getMessageId(),response_to:"",agent_id:{"#text":this.agentId},message:{"#text":this.message}}};return JSON.stringify(a)};var m=function(){function a(){return{loginRequest:null,configRequest:null,logoutRequest:null,agentStateRequest:null,loginPacket:null,configPacket:null,agentStatePacket:null,currentCallPacket:null,applicationSettings:{availableCountries:[],isLoggedInIS:!1,socketConnected:!1,message:"",isTcpaSafeMode:!1},agentSettings:{agentId:0,agentType:"AGENT",altDefaultLoginDest:"",availableAgentStates:[],callerIds:[],currentState:"OFFLINE",currentStateLabel:"",defaultLoginDest:"",dialDest:"",email:"",externalAgentId:"",firstName:"",isLoggedIn:!1,initLoginState:"AVAILABLE",initLoginStateLabel:"Available",isOutboundPrepay:!1,lastName:"",loginDTS:null,loginType:"NO-SELECTION",maxBreakTime:-1,maxLunchTime:-1,onCall:!1,outboundManualDefaultRingtime:"30",realAgentType:"AGENT",updateLoginMode:!1},agentPermissions:{allowBlended:!0,allowCallControl:!0,allowChat:!1,allowCrossQueueRequeue:!1,allowInbound:!0,allowLeadInserts:!1,allowLeadSearch:!1,allowLoginControl:!0,allowLoginUpdates:!0,allowManualCalls:!0,allowManualPass:!0,allowManualIntlCalls:!1,allowManualOutboundGates:!1,allowOffHook:!0,allowOutbound:!0,allowPreviewLeadFilters:!1,allowLeadUpdatesByCampaign:{},disableSupervisorMonitoring:!0,requireFetchedLeadsCalled:!1,showLeadHistory:!0},chatSettings:{availableChatQueues:[],availableChatRooms:[],chatQueues:[],alias:""},connectionSettings:{hashCode:null,reconnect:!1},inboundSettings:{availableQueues:[],availableSkillProfiles:[],queues:[],skillProfile:{}},outboundSettings:{availableCampaigns:[],availableOutdialGroups:[],insertCampaigns:[],outdialGroup:{}},surveySettings:{availableSurveys:[]}}}var b;return{getInstance:function(){return b||(b=a()),b}}}(),n={sendMessage:function(a,b){1===a.socket.readyState?a.socket.send(b):console.warn("WebSocket is not connected")},processMessage:function(a,b){var c=b.ui_response["@type"],d=b.ui_response["@message_id"],e=""===d?"IS":d.slice(0,2);switch(console.log("AgentLibrary: received message: ("+e+") "+c.toUpperCase()),n.fireCallback(a,o.ON_MESSAGE,b),c.toUpperCase()){case p.LOGIN:"IS"===e?(m.getInstance().loginRequest.processResponse(b),n.fireCallback(a,o.LOGIN,b)):"IQ"===e&&(m.getInstance().configRequest.processResponse(b),n.fireCallback(a,o.CONFIG,b));break;case p.LOGOUT:n.fireCallback(a,o.LOGOUT,b);break;case p.AGENT_STATE:null===m.getInstance().agentStateRequest&&(m.getInstance().agentStateRequest=new i(b.ui_response.current_state["#text"],b.ui_response.agent_aux_state["#text"])),m.getInstance().agentStateRequest.processResponse(b),n.fireCallback(a,o.AGENT_STATE,b)}},processResponseCollection:function(a,b,c){var d=[],e={},f=[];if("undefined"!=typeof a[b][c]&&(f=a[b][c]),Array.isArray(f))for(var g=0;g<f.length;g++){var h="";for(var i in f[g])if(h=i.replace(/@/,""),h=h.replace(/_([a-z])/g,function(a){return a[1].toUpperCase()}),"object"==typeof f[g][i]){var j=Object.keys(f[g][i])[0],k=[];k=n.processResponseCollection(f[g],i,j),e[h]=k}else e[h]=f[g][i];d.push(e),e={}}else{var l="";for(var m in f)if(l=m.replace(/@/,""),l=l.replace(/_([a-z])/g,function(a){return a[1].toUpperCase()}),"object"==typeof f[m]){var o=Object.keys(f[m])[0],p=[];p=n.processResponseCollection(f,m,o),e[l]=f[m]}else e[l]=f[m];d.push(e)}return d},fireCallback:function(a,b,c){c=c||"","function"==typeof a.callbacks[b]&&a.callbacks[b].call(a,c)},setCallback:function(a,b,c){"undefined"!=typeof c&&(a.callbacks[b]=c)},getMessageId:function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},checkExistingIds:function(a,b,c){for(var d=[],e=[],f=0;f<a.length;f++)d.push(a[f][c]);for(var g=0;g<b.length;g++)-1===d.indexOf(b[g])&&e.push(b[g]);for(var h=b.length-1;h>=0;h--)e.indexOf(b[h])>-1&&b.splice(h,1);return b}};const o={HELLO:"helloResponse",OPEN_SOCKET:"openResponse",CLOSE_SOCKET:"closeResponse",LOGIN:"loginResponse",CONFIG:"configureResponse",AGENT_STATE:"agentStateResponse"},p={LOGIN:"LOGIN",LOGOUT:"LOGOUT",AGENT_STATE:"AGENT-STATE",ON_MESSAGE:"ON-MESSAGE"};var q=function(a){return f(a),g(a),h(a),a.AgentLibrary};"function"==typeof define&&define.amd?(console.log("AgentLibrary: using AMD"),define(function(){return q({})})):"object"==typeof module&&module.exports?(console.log("AgentLibrary: Using Node"),module.exports=q(this)):(console.log("AgentLibrary: Not using AMD"),q(this))}(this);